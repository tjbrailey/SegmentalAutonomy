---
title: "03 Data Analysis"
author: "Thomas J. Brailey"
date: "29/09/2019"
output:
  pdf_document:
    toc: yes
    keep_tex: yes
  html_notebook:
    toc: yes
    toc_float: yes
  html_document:
    toc: yes
editor_options:
  chunk_output_type: inline
---
<style>
    body .main-container {
        max-width: 100%;
    }
</style>

```{r setup, include=FALSE}
rm(list=ls())
knitr::opts_chunk$set(echo = TRUE)
library(magrittr)
library(ggplot2)
```

# Load data
```{r}
# Load PSP data, created in tjbrailey_wrangle_data.Rmd.
psp <- rio::import(paste0(here::here(), "/data/tjbrailey_psp_clean.csv"))
psp <- psp[,-1]

# Load esssential scripts
source(paste0(here::here(), "/R/csts.R"))
source(paste0(here::here(), "/R/lm.R"))
```

# Cross-sectional analyses
## UCDP conflict rates
```{r}
csts("ucdp_cumulative_intensity", "dpi_auton")
```

## QOG support/satisfaction with democracy
```{r}
csts("qog_hum_trust", "dpi_auton")

csts("qog_hum_supdem", "dpi_auton")

csts("qog_hum_satdem", "dpi_auton")
```

## PolityIV scores
```{r}
csts("polity4_polity_score", "dpi_auton")
```









# Linear regressions 
## QOG support/satisfaction with democracy
```{r}
psp_lm("qog_hum_trust", "dpi_auton")
psp_lm("qog_hum_trust", "epr_reg_aut_dum")
psp_lm("qog_hum_trust", "rai_n_RAI")
```

## PolityIV scores
```{r}
# Polity score with DPI measurement of autonomy 
psp_lm("polity4_polity_score", "dpi_auton")

# Free and fair elections (robustness checks)
psp_lm("v2elfrfair", "dpi_auton")

# Polity score with different measurements of regional autonomy (robustness checks)
psp_lm("polity4_polity_score", "epr_reg_aut_dum")
psp_lm("polity4_polity_score", "rai_n_RAI")
```

# Cox regressions
```{r}
# DPI
cox1 <- survival::coxph(survival::Surv(year, ucdp_cumulative_intensity) ~ (dpi_auton * tb_other_provis) + qog_wbgi_pve + qog_wdi_gini + qog_gle_pop + polity4_polity_score, data = psp)
#summary(cox1)
#reporttools::displayCoxPH(cox1)

# EPR
cox2 <- survival::coxph(survival::Surv(year, ucdp_cumulative_intensity) ~ (epr_reg_aut_dum * tb_other_provis) + as.factor(country) + qog_wbgi_pve + qog_wdi_gini + qog_gle_pop + polity4_polity_score, data = psp)
#summary(cox2)
#reporttools::displayCoxPH(cox2)

# RAI
cox3 <- survival::coxph(survival::Surv(year, ucdp_cumulative_intensity) ~ (rai_n_RAI * tb_other_provis) + as.factor(country) + qog_wbgi_pve + qog_wdi_gini + qog_gle_pop + polity4_polity_score, data = psp)
#summary(cox3)
#reporttools::displayCoxPH(cox3)
```
# Multivariate comparison across operationalizations
```{r}
psp <- psp %>%
    dplyr::mutate_if(is.numeric, round, digits = 3) %>%
    dplyr::filter(qog_fe_etfra > median(psp$qog_fe_etfra, na.rm = TRUE))

dpi_reg <- estimatr::lm_robust(polity4_polity_score ~ (dpi_auton * tb_other_provis) + as.factor(country) + as.factor(year) + qog_wbgi_pve + qog_wdi_gini + qog_gle_pop, data = psp, se_type = "CR2", clusters = country)

epr_reg <- estimatr::lm_robust(polity4_polity_score ~ (epr_reg_aut_dum * tb_other_provis) + as.factor(country) + as.factor(year) + qog_wbgi_pve + qog_wdi_gini + qog_gle_pop, data = psp, se_type = "CR2", clusters = country)

rai_reg <- estimatr::lm_robust(polity4_polity_score ~ (rai_n_RAI * tb_other_provis) + as.factor(country) + as.factor(year) + qog_wbgi_pve + qog_wdi_gini + qog_gle_pop, data = psp, se_type = "CR2", clusters = country)

tex_fin <- texreg::texreg(list(dpi_reg, epr_reg, rai_reg), mfrow = TRUE, 
                                omit.coef = "as.factor", 
                                include.ci = FALSE, 
                                custom.gof.rows = list(`Country fixed effects` = c("Y", "Y", "Y"),
                                                       `Year fixed effects` = c("Y", "Y", "Y")))
tex_fin
```
# Simple SJ Coefficient Plots
```{r}
sj <- estimatr::lm_robust(polity4_polity_score ~ dpi_auton * tb_other_provis + as.factor(country) + as.factor(year) +
                            qog_wbgi_pve + qog_wdi_gini + qog_gle_pop + polity4_polity_score
                               , 
                             data = psp, se_type = "CR2", clusters = country)
sjPlot::plot_model(sj)
```